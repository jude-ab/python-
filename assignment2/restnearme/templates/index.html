{% load static%}
<!DOCTYPE html>
<html>
<head>
    <title>Michelin Restaurants</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" /> 
    <link rel="stylesheet" href="{% static 'style.css' %}">
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <div class="text-start">
                <a class="navbar-brand" href="#">
                {% if request.user.is_authenticated %}
                    <a href="{% url 'user_logout' %}" class="navbar-text text-white" >Logout</a>
                {% endif %}
            </div>
            <div class="mx-auto d-md-block">
                <a class="navbar-brand" href="#">One-star Michelin Restaurants</a>
            </div>
        </div>
    </nav>    
    <div class="row justify-content-center">
        <div class="col-md- text-center">
            <div id="map" class="mt-5 mb-4" style="height: 500px;"></div>
            <p id="mapDescription">
                This map shows the locations of all one-start Michelin restaurants.
                <br>
                Michel Star restaurants are awarded to restaurants that serve exceptional food, and are a symbol of fine dining quality.
            </p>
        </div>
    </div>
    <div class="row justify-content-center">
        <div class="col-md-6 col-sm-8 col-12 text-center"> <!-- Center align the button -->
            <button id="getLocationButton" class="btn btn-dark btn-block">Get My Current Location!</button>
        </div>
    </div>    
    <script>
        var map = L.map('map', { doubleClickZoom: false }).setView([53.349805, -7.261649], 6); // Center of Ireland with a zoom level of 6
        
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        function onLocationFound(e) {
            var radius = e.accuracy;
            var latitude = e.latlng.lat;
            var longitude = e.latlng.lng;
            var location = latitude + ", " + longitude;

            L.marker(e.latlng).addTo(map)
                .bindPopup("Location Found at:\n\nLatitude: " + latitude + ", Longitude: " + longitude).openPopup();

            L.circle(e.latlng, radius).addTo(map);
        }

        //location found event listener
        map.on('locationfound', onLocationFound);

        //GetCurrent Location button click event
        document.getElementById('getLocationButton').addEventListener('click', function() {
            map.locate({ setView: true, maxZoom: 30 });
        });

        var m_restaurants = [
            {% for restaurant in michelin_restaurants %}
                {
                    "latitude": {{ restaurant.latitude }},
                    "longitude": {{ restaurant.longitude }},
                    "name": "{{ restaurant.name|escapejs }}",
                    "cuisine": "{{ restaurant.cuisine|escapejs }}",
                    "price": "{{ restaurant.price|escapejs }}",
                    "url": "{{ restaurant.url|escapejs }}"
                }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];

// Looping through the m_restaurants and add markers for each data point
        m_restaurants.forEach(function(data) {
            var popupContent = `
                <h3>${data.name}</h3>
                <p>Cuisine: ${data.cuisine}<br>
                Price Range: ${data.price}<br>
                <a href="${data.url}" target="_blank">Visit Website</a></p>
            `;
            L.marker([data.latitude, data.longitude]).addTo(map).bindPopup(popupContent);
        });

        console.log(m_restaurants);

    </script>
</body>
</html>
