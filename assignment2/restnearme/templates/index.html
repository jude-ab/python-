{% load static %}
<!DOCTYPE html>
<html>
  <head>
    <title>Michelin Restaurants</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    />
    <link rel="stylesheet" href="{% static 'style.css' %}" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  </head>

  <body>
    <nav class="navbar navbar-dark bg-dark">
      <div class="container">
        <div class="text-start">
          <button
            class="btn"
            type="button"
            data-bs-toggle="offcanvas"
            data-bs-target="#offcanvasDrawer"
            aria-controls="offcanvasDrawer"
          >
            <span class="navbar-toggler-icon"></span>
          </button>
          {% if request.user.is_authenticated %}
          <a href="{% url 'user_logout' %}" class="navbar-text text-white"
            >Logout</a
          >
          {% endif %}
        </div>
        <div class="mx-auto d-md-block">
          <a class="navbar-brand">One-star Michelin Restaurants</a>
        </div>
      </div>
    </nav>
    <!-- <div class="row justify-content-center">
      <div class="col-md-6 col-sm-8 col-12 text-center mt-3">
        <button id="reloadLocationsButton" class="btn btn-dark btn-block">
          Reload
        </button>
      </div>
    </div> -->
    <div class="row justify-content-center">
      <div class="col-md- text-center">
        <div id="map" class="mt-5 mb-4" style="height: 500px"></div>
        <p id="mapDescription">
          This map shows the locations of all one-star Michelin restaurants
          around the world.<br />
          Michel Star restaurants are awarded to restaurants that serve
          exceptional food, and are a symbol of fine dining quality.
        </p>
      </div>
    </div>
    <div
      class="offcanvas offcanvas-start"
      tabindex="-1"
      id="offcanvasDrawer"
      aria-labelledby="offcanvasDrawerLabel"
    >
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="offcanvasDrawerLabel">
          Michelin Restaurants
        </h5>
        <button
          type="button"
          class="btn-close text-reset"
          data-bs-dismiss="offcanvas"
          aria-label="Close"
        ></button>
      </div>
      <div class="offcanvas-body">
        <!-- search bar-->
        <div class="row justify-content-center my-4">
          <div class="col-md-6 col-sm-8 col-12 text-center">
            <input
              type="text"
              id="searchInput"
              class="form-control mb-2"
              placeholder="Search Name..."
            />
            <button id="searchButton" class="btn btn-dark btn-block">
              Search
            </button>
          </div>
        </div>
        <div class="row justify-content-center">
          <div class="col-md-6 col-sm-8 col-12 text-center mb-3">
            <button id="getLocationButton" class="btn btn-dark btn-block">
              Get My Current Location!
            </button>
          </div>
        </div>
        <!-- Button to Show User Locations -->
        <div class="row justify-content-center">
          <div class="col-md-6 col-sm-8 col-12 text-center mt-3">
            <button id="showUsersButton" class="btn btn-dark btn-block">
              Show Friend's Locations
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- User List Modal -->
    <div
      class="modal fade"
      id="userListModal"
      tabindex="-1"
      aria-labelledby="userListModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="userListModalLabel">User List</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <ul id="userList" class="list-group"></ul>
          </div>
        </div>
      </div>
    </div>

    <!-- JavaScript to Handle Map and User Locations -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"></script>
    <script>
      // JavaScript to Handle Map and User Locations
      var map = L.map('map', { doubleClickZoom: false }).setView([53.349805, -7.261649], 6); // Center of Ireland with a zoom level of 6

      L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      }).addTo(map);

      // Function to handle marker click and display weather information
      function onMarkerClick(e) {
          var marker = e.target;
          var latitude = marker.getLatLng().lat;
          var longitude = marker.getLatLng().lng;

          // Fetch weather data using the OpenWeatherMap API
          fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${latitude}&lon=${longitude}&appid=375c9e18454382c33fdb0c94fb81b283&units=metric`)
              .then(response => response.json())
              .then(weatherData => {
                  // Extract relevant weather information
                  var temperature = weatherData.main.temp;
                  var description = weatherData.weather[0].description;

                  // Update the weatherInfo element in the popup
                  var weatherInfoElement = document.getElementById('weatherInfo');
                  weatherInfoElement.innerHTML = `
                      <p>Temperature: ${temperature}Â°C</p>
                      <p>Weather: ${description}</p>
                  `;
              })
              .catch(error => {
                  console.error('Error fetching weather data:', error);
                  var weatherInfoElement = document.getElementById('weatherInfo');
                  weatherInfoElement.innerHTML = '<p>Weather data not available.</p>';
              });

          // Open the popup
          marker.openPopup();
      }

      function onLocationFound(e) {
          var radius = e.accuracy;
          var latitude = e.latlng.lat;
          var longitude = e.latlng.lng;
          L.marker(e.latlng).addTo(map)
              .bindPopup("Location Found at:\n\nLatitude: " + latitude + ", Longitude: " + longitude).openPopup();
          L.circle(e.latlng, radius).addTo(map);
      }

      // Location found event listener
      map.on('locationfound', onLocationFound);

      // Function to close the side drawer
      function closeSideDrawer() {
          var offcanvasElement = document.getElementById("offcanvasDrawer");
          var offcanvasInstance = bootstrap.Offcanvas.getInstance(offcanvasElement);
          offcanvasInstance.hide();
      }

      // Get Current Location button click event
      document.getElementById('getLocationButton').addEventListener('click', function () {
          map.locate({ setView: true, maxZoom: 30 });
          closeSideDrawer();
      });

      // Function to fetch users and populate the modal
      function fetchUsersAndPopulateModal() {
          fetch('/restnearme/api/users/')  // Update with your actual API endpoint
              .then(response => response.json())
              .then(users => {
                  let userListEl = document.getElementById('userList');
                  userListEl.innerHTML = '';  // Clear existing list items
                  users.forEach(user => {
                      let li = document.createElement('li');
                      li.className = 'list-group-item list-group-item-action'
                      li.style.cursor = 'pointer';
                      li.textContent = user.username;
                      li.addEventListener('click', function() {
                          let userLocation = [user.location.latitude, user.location.longitude];
                          showUserLocationOnMap(userLocation, user.username);  // Pass the username to the function
                          $('#userListModal').modal('hide');  // Hide the modal after selection
                      });
                      userListEl.appendChild(li);
                  });
              })
              .catch(error => console.error('Error fetching users:', error));
      }

      // Variable to store the open popup
      let openPopup = null;

      // Function to show user location on the map
      function showUserLocationOnMap(location, userName) {
          if (!location) return;
          let [latitude, longitude] = location;

          // Close the previously opened popup (if any)
          if (openPopup) {
              openPopup.closePopup();
          }

          // Add the new user marker and open its popup
          let userMarker = L.marker([latitude, longitude]).addTo(map);
          map.setView([latitude, longitude], 10); // Set the map view to the user's location
          openPopup = userMarker.bindPopup(`${userName}'s Location`).openPopup(); // Display user's name in popup
      }

      // Event listener for the 'Show User Locations' button
      document.getElementById('showUsersButton').addEventListener('click', function() {
          fetchUsersAndPopulateModal();
          $('#userListModal').modal('show');  // Using jQuery to show the modal
          closeSideDrawer();
      });

      // Existing code to handle restaurant markers
      var m_restaurants = [
          {% for restaurant in michelin_restaurants %}
          {
              "latitude": {{ restaurant.latitude }},
              "longitude": {{ restaurant.longitude }},
              "name": "{{ restaurant.name|escapejs }}",
              "cuisine": "{{ restaurant.cuisine|escapejs }}",
              "price": "{{ restaurant.price|escapejs }}",
              "url": "{{ restaurant.url|escapejs }}",
          }{% if not forloop.last %},{% endif %}
          {% endfor %}
      ];

      m_restaurants.forEach(function (data) {
          var popupContent = `
              <h3>${data.name}</h3>
              <p>Cuisine: ${data.cuisine}<br>
              Price Range: ${data.price}<br>
              <a href="${data.url}" target="_blank">Visit Website</a></p>

              <div id="weatherInfo">
                  <p>Loading weather information...</p>
              </div>
          `;
          var marker = L.marker([data.latitude, data.longitude]).addTo(map).bindPopup(popupContent);

          // Add a click event listener to each marker
          marker.on('click', onMarkerClick);
      });

      // Function to search restaurants and update the map
      function searchRestaurants() {
          let searchTerm = document.getElementById('searchInput').value.toLowerCase();
          let searchedRestaurants = m_restaurants.filter(restaurant =>
              restaurant.name?.toLowerCase().includes(searchTerm)
          );

          // // Clear existing markers
          // map.eachLayer(layer => {
          //     if (!!layer.toGeoJSON) { // Check if layer is a marker
          //         map.removeLayer(layer);
          //     }
          // });

          // Add markers for searched restaurants
          searchedRestaurants.forEach(data => {
              var popupContent = `
                  <h3>${data.name}</h3>
                  <p>Cuisine: ${data.cuisine}<br>
                  City: ${data.city}<br>
                  Price Range: ${data.price}<br>
                  <a href="${data.url}" target="_blank">Visit Website</a></p>
              `;
              L.marker([data.latitude, data.longitude]).addTo(map).bindPopup(popupContent);
          });

          // If there are results, pan to the first result
          if (searchedRestaurants.length > 0) {
              map.setView([searchedRestaurants[0].latitude, searchedRestaurants[0].longitude], 13);
          } else {
              alert('No restaurants found with that search term.');
          }
      }

      // Event listener for the search button
      document.getElementById('searchButton').addEventListener('click', function() {
          searchRestaurants();
          closeSideDrawer(); // Close the side drawer after search
      });

      // Function to fetch restaurant locations and update the map
      // function reloadLocationsFromDatabase() {
      //     fetch('/restnearme/map/')  // Update with your actual API endpoint for restaurants
      //         .then(response => response.json())
      //         .then(restaurants => {
      //             // Clear existing markers
      //             map.eachLayer(layer => {
      //                 if (!!layer.toGeoJSON) { // Check if layer is a marker
      //                     map.removeLayer(layer);
      //                 }
      //             });

      //             // Add markers for fetched restaurants
      //             restaurants.forEach(data => {
      //                 var popupContent = `
      //                     <h3>${data.name}</h3>
      //                     <p>Cuisine: ${data.cuisine}<br>
      //                     City: ${data.city}<br>
      //                     Price Range: ${data.price}<br>
      //                     <a href="${data.url}" target="_blank">Visit Website</a></p>
      //                 `;
      //                 L.marker([data.latitude, data.longitude]).addTo(map).bindPopup(popupContent);
      //             });
      //         })
      //         .catch(error => console.error('Error fetching restaurants:', error));
      // }

      // Event listener for the 'Reload Locations from Database' button
      document.getElementById('reloadLocationsButton').addEventListener('click', function() {
          // reloadLocationsFromDatabase();
          closeSideDrawer(); // Close the side drawer after reloading
      });
    </script>
  </body>
</html>
